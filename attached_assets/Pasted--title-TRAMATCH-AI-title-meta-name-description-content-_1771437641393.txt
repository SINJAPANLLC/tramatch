" />
    <title>トラマッチ（TRAMATCH）｜国内最大級のAI求荷求車サービス</title>
    <meta name="description" content="トラマッチは運送会社と荷物を運んで欲しい会社をつなぐ国内最大級のAI求荷求車サービスです。" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="canonical" href="https://tramatch-sinjapan.com/" />
    <meta property="og:title" content="トラマッチ（TRAMATCH）｜国内最大級のAI求荷求車サービス" />
    <meta property="og:description" content="トラマッチは運送会社と荷物を運んで欲しい会社をつなぐ国内最大級のAI求荷求車サービスです。" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://tramatch-sinjapan.com/" />
    <meta property="og:image" content="https://tramatch-sinjapan.com/og-image.png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:site_name" content="トラマッチ" />
    <meta property="og:locale" content="ja_JP" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="トラマッチ（TRAMATCH）｜国内最大級のAI求荷求車サービス" />
    <meta name="twitter:description" content="トラマッチは運送会社と荷物を運んで欲しい会社をつなぐ国内最大級のAI求荷求車サービスです。" />
    <meta name="twitter:image" content="https://tramatch-sinjapan.com/og-image.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Fira+Code:wght@300..700&family=Geist+Mono:wght@100..900&family=Geist:wght@100..900&family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=IBM+Plex+Sans:ital,wght@0,100..700;1,100..700&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Lora:ital,wght@0,400..700;1,400..700&family=Merriweather:ital,opsz,wght@0,18..144,300..900;1,18..144,300..900&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Outfit:wght@100..900&family=Oxanium:wght@200..800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&family=Roboto:ital,wght@0,100..900;1,100..900&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&family=Space+Grotesk:wght@300..700&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
root@srv1087935:/var/www/tramatch# grep -r "replit" /var/www/tramatch/dist/index.js | head -5
grep -r "tramatch.jp" /var/www/tramatch/dist/index.js | head -5
grep: /var/www/tramatch/dist/index.js: No such file or directory
grep: /var/www/tramatch/dist/index.js: No such file or directory
root@srv1087935:/var/www/tramatch# ls /var/www/tramatch/dist/
index.cjs  public
root@srv1087935:/var/www/tramatch# grep -r "replit\|tramatch\.jp" /var/www/tramatch/dist/ --include="*.js" | head -10
root@srv1087935:/var/www/tramatch# grep -r "replit\|tramatch\.jp" /var/www/tramatch/dist/index.cjs | head -10
`,w=v.charCodeAt(0),_=new RegExp((d=="|"?"\\|":d)+"+$"),S="",T=[];l.dense=Array.isArray(n);for(var F=l.skipHidden&&n["!cols"]||[],P=l.skipHidden&&n["!rows"]||[],N=u.s.c;N<=u.e.c;++N)(F[N]||{}).hidden||(T[N]=Mr(N));var k=u.s.r,O=!1,q=0;return s._read=function(){if(!O)return O=!0,s.push("\uFEFF");for(;k<=u.e.r;)if(++k,!(P[k-1]||{}).hidden&&(S=L8(n,u,k-1,T,m,w,d,l),S!=null&&(l.strip&&(S=S.replace(_,"")),S||l.blankrows!==!1)))return s.push((q++?v:"")+S);return s.push(null)},s}function Kte(n,o){var s=um(),l=o||{},u=l.header!=null?l.header:p8,d=l.footer!=null?l.footer:f8;s.push(u);var m=xn(n["!ref"]);l.dense=Array.isArray(n),s.push(d8(n,m,l));var v=m.s.r,w=!1;return s._read=function(){if(v>m.e.r)return w||(w=!0,s.push("</table>"+d)),s.push(null);for(;v<=m.e.r;){s.push(u8(n,m,v,l)),++v;break}},s}function Qte(n,o){var s=um({objectMode:!0});if(n==null||n["!ref"]==null)return s.push(null),s;var l={t:"n",v:0},u=0,d=1,m=[],v=0,w="",_={s:{r:0,c:0},e:{r:0,c:0}},S=o||{},T=S.range!=null?S.range:n["!ref"];switch(S.header===1?u=1:S.header==="A"?u=2:Array.isArray(S.header)&&(u=3),typeof T){case"string":_=fr(T);break;case"number":_=fr(n["!ref"]),_.s.r=T;break;default:_=T}u>0&&(d=0);var F=Zr(_.s.r),P=[],N=0,k=Array.isArray(n),O=_.s.r,q=0,U={};k&&!n[O]&&(n[O]=[]);var L=S.skipHidden&&n["!cols"]||[],le=S.skipHidden&&n["!rows"]||[];for(q=_.s.c;q<=_.e.c;++q)if(!(L[q]||{}).hidden)switch(P[q]=Mr(q),l=k?n[O][q]:n[P[q]+F],u){case 1:m[q]=q-_.s.c;break;case 2:m[q]=P[q];break;case 3:m[q]=S.header[q-_.s.c];break;default:if(l==null&&(l={w:"__EMPTY",t:"s"}),w=v=as(l,null,S),N=U[v]||0,!N)U[v]=1;else{do w=v+"_"+N++;while(U[w]);U[v]=N,U[w]=1}m[q]=w}return O=_.s.r+d,s._read=function(){for(;O<=_.e.r;)if(!(le[O-1]||{}).hidden){var he=D8(n,_,O,P,u,m,k,S);if(++O,he.isempty===!1||(u===1?S.blankrows!==!1:S.blankrows)){s.push(he.row);return}}return s.push(null)},s}var U8={to_json:Qte,to_html:Kte,to_csv:Gte,set_readable:q8};if(typeof am<"u"&&(i.parse_xlscfb=am),i.parse_zip=k8,i.read=sm,i.readFile=I8,i.readFileSync=I8,i.write=cm,i.writeFile=O8,i.writeFileSync=O8,i.writeFileAsync=jte,i.utils=Vte,i.writeXLSX=_y,i.writeFileXLSX=Lte,i.SSF=jk,typeof U8<"u"&&(i.stream=U8),typeof Ft<"u"&&(i.CFB=Ft),typeof require<"u"){var $8=require("stream");($8||{}).Readable&&q8($8.Readable)}}typeof yk<"u"?p1(yk):typeof Ih<"u"&&Ih.exports?p1(Ih.exports):typeof define=="function"&&define.amd?define("xlsx",function(){return Fh.version||p1(Fh),Fh}):p1(Fh);if(typeof window<"u"&&!window.XLSX)try{window.XLSX=Fh}catch{}});var oH={};gd(oH,{seedDatabase:()=>kEe});async function kEe(){let i=await je.select({count:X`count(*)`}).from(Xt);if(Number(i[0].count)===0){let e=await _k.default.hash("admin123",10),t=await _k.default.hash("Kazuya8008",10);await je.insert(Xt).values([{username:"admin",password:e,companyName:"\u30C8\u30E9\u30DE\u30C3\u30C1\u904B\u55B6",phone:"03-0000-0000",email:"admin@tramatch.jp",userType:"admin",role:"admin",approved:!0},{username:"sinjapan",password:t,companyName:"SIN JAPAN",phone:"03-0000-0001",email:"info@sinjapan.jp",userType:"admin",role:"admin",approved:!0}]),console.log("Admin users created")}else console.log("Database already has users, skipping seed.")}var _k,cH=Z(()=>{"use strict";Zx();N0();w0();_k=ln(require("bcrypt"),1)});var FEe={};gd(FEe,{log:()=>Sk});module.exports=gre(FEe);var m1=ln(Pg(),1),Ek=ln(OD(),1),uH=ln(S7(),1);var rH=ln(Pg(),1);ES();N0();Gx();Gx();function Qj(i){return i instanceof Error&&i.name==="ZodError"&&"issues"in i&&Array.isArray(i.issues)}var SS=class extends Error{name;details;constructor(i,e){super(i,e),this.name="ZodValidationError",this.details=tve(e)}toString(){return this.message}};function tve(i){if(i){let e=i.cause;if(Qj(e))return e.issues}return[]}function Xj(i){return i.length!==0}function Kj(i){return i.description??""}var rve=/[$_\p{ID_Start}][$\u200c\u200d\p{ID_Continue}]*/u;function ive(i){if(i.length===1){let e=i[0];return typeof e=="symbol"&&(e=Kj(e)),e.toString()||'""'}return i.reduce((e,t)=>{if(typeof t=="number")return e+"["+t.toString()+"]";if(typeof t=="symbol"&&(t=Kj(t)),t.includes('"'))return e+'["'+nve(t)+'"]';if(!rve.test(t))return e+'["'+t+'"]';let r=e.length===0?"":".";return e+r+t},"")}function nve(i){return i.replace(/"/g,'\\"')}var ave="; ",sve=99,Yj="Validation error",ove=": ",cve=", or ";function lve(i={}){let{issueSeparator:e=ave,unionSeparator:t=cve,prefixSeparator:r=ove,prefix:a=Yj,includePath:c=!0,maxIssuesInMessage:p=sve}=i;return f=>{let y=f.slice(0,p).map(b=>ev({issue:b,issueSeparator:e,unionSeparator:t,includePath:c})).join(e);return uve(y,a,r)}}function ev(i){let{issue:e,issueSeparator:t,unionSeparator:r,includePath:a}=i;if(e.code===ze.invalid_union)return e.unionErrors.reduce((c,p)=>{let f=p.issues.map(y=>ev({issue:y,issueSeparator:t,unionSeparator:r,includePath:a})).join(t);return c.includes(f)||c.push(f),c},[]).join(r);if(e.code===ze.invalid_arguments)return[e.message,...e.argumentsError.issues.map(c=>ev({issue:c,issueSeparator:t,unionSeparator:r,includePath:a}))].join(t);if(e.code===ze.invalid_return_type)return[e.message,...e.returnTypeError.issues.map(c=>ev({issue:c,issueSeparator:t,unionSeparator:r,includePath:a}))].join(t);if(a&&Xj(e.path)){if(e.path.length===1){let c=e.path[0];if(typeof c=="number")return`${e.message} at index ${c}`}return`${e.message} at "${ive(e.path)}"`}return e.message}function uve(i,e,t){return e!==null?i.length>0?[e,i].join(t):e:i.length>0?i:Yj}function pve(i,e={}){let t=i.errors,r;return Xj(t)?r=fve(e)(t):r=i.message,new SS(r,{cause:i})}function fve(i){return"messageBuilder"in i?i.messageBuilder:lve(i)}var dve=(i={})=>e=>Qj(e)?pve(e,i):e instanceof Error?new SS(e.message,{cause:e}):new SS("Unknown error");function Cs(i,e={}){return dve(e)(i)}var es=ln(require("bcrypt"),1),Ph=ln(Rq(),1),d1=ln(require("path"),1),bk=ln(require("fs"),1),f1=ln(require("crypto"),1);i1();i1();var t$=require("child_process"),pu=require("fs/promises"),v3=require("crypto"),y3=require("os"),b3=require("path"),Z2e=new Dt({apiKey:process.env.OPENAI_API_KEY||process.env.AI_INTEGRATIONS_OPENAI_API_KEY,...process.env.OPENAI_API_KEY?{}:process.env.AI_INTEGRATIONS_OPENAI_BASE_URL?{baseURL:process.env.AI_INTEGRATIONS_OPENAI_BASE_URL}:{}});function e_e(i){return i.length<12?"unknown":i[0]===82&&i[1]===73&&i[2]===70&&i[3]===70?"wav":i[0]===26&&i[1]===69&&i[2]===223&&i[3]===163?"webm":i[0]===255&&(i[1]===251||i[1]===250||i[1]===243)||i[0]===73&&i[1]===68&&i[2]===51?"mp3":i[4]===102&&i[5]===116&&i[6]===121&&i[7]===112?"mp4":i[0]===79&&i[1]===103&&i[2]===103&&i[3]===83?"ogg":"unknown"}async function t_e(i){let e=(0,b3.join)((0,y3.tmpdir)(),`input-${(0,v3.randomUUID)()}`),t=(0,b3.join)((0,y3.tmpdir)(),`output-${(0,v3.randomUUID)()}.wav`);try{return await(0,pu.writeFile)(e,i),await new Promise((r,a)=>{let c=(0,t$.spawn)("ffmpeg",["-i",e,"-vn","-f","wav","-ar","16000","-ac","1","-acodec","pcm_s16le","-y",t]);c.stderr.on("data",()=>{}),c.on("close",p=>{p===0?r():a(new Error(`ffmpeg exited with code ${p}`))}),c.on("error",a)}),await(0,pu.readFile)(t)}finally{await(0,pu.unlink)(e).catch(()=>{}),await(0,pu.unlink)(t).catch(()=>{})}}async function r$(i){let e=e_e(i);return e==="wav"?{buffer:i,format:"wav"}:e==="mp3"?{buffer:i,format:"mp3"}:{buffer:await t_e(i),format:"wav"}}async function i$(i,e="wav"){let t=await Qp(i,`audio.${e}`);return(await Z2e.audio.transcriptions.create({file:t,model:"gpt-4o-mini-transcribe"})).text}var hu=require("square");var Qz=ln(Kz(),1),u1=null;function wEe(){if(u1)return u1;let i=process.env.SMTP_HOST,e=parseInt(process.env.SMTP_PORT||"587"),t=process.env.SMTP_USER,r=process.env.SMTP_PASS;return!i||!t||!r?null:(u1=Qz.default.createTransport({host:i,port:e,secure:e===465,auth:{user:t,pass:r}}),u1)}async function Ic(i,e,t){let r=wEe();if(!r)return{success:!1,error:"\u30E1\u30FC\u30EB\u8A2D\u5B9A\u304C\u672A\u69CB\u6210\u3067\u3059"};let a=process.env.SMTP_FROM||process.env.SMTP_USER||"noreply@tramatch.jp";try{return await r.sendMail({from:a,to:i,subject:e,text:t,html:t.replace(/\n/g,"<br>")}),{success:!0}}catch(c){return console.error("Email send error:",c),{success:!1,error:c.message}}}async function hk(i,e){let t=process.env.LINE_CHANNEL_ACCESS_TOKEN;if(!t)return{success:!1,error:"LINE\u8A2D\u5B9A\u304C\u672A\u69CB\u6210\u3067\u3059"};try{let r=await fetch("https://api.line.me/v2/bot/message/push",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({to:i,messages:[{type:"text",text:e}]})});if(!r.ok){let a=await r.text();return console.error("LINE API error:",r.status,a),{success:!1,error:`LINE API error: ${r.status}`}}return{success:!0}}catch(r){return console.error("LINE send error:",r),{success:!1,error:r.message}}}function mk(){return!!(process.env.SMTP_HOST&&process.env.SMTP_USER&&process.env.SMTP_PASS)}function Xz(){return!!process.env.LINE_CHANNEL_ACCESS_TOKEN}vk();var Df=ln(eH(),1),Of=new Dt({apiKey:process.env.OPENAI_API_KEY||process.env.AI_INTEGRATIONS_OPENAI_API_KEY,...process.env.OPENAI_API_KEY?{}:process.env.AI_INTEGRATIONS_OPENAI_BASE_URL?{baseURL:process.env.AI_INTEGRATIONS_OPENAI_BASE_URL}:{}}),h1=d1.default.join(process.cwd(),"uploads");bk.default.existsSync(h1)||bk.default.mkdirSync(h1,{recursive:!0});var CEe=(0,Ph.default)({storage:Ph.default.diskStorage({destination:(i,e,t)=>t(null,h1),filename:(i,e,t)=>{let r=d1.default.extname(e.originalname);t(null,`permit_${Date.now()}${r}`)}}),limits:{fileSize:10*1024*1024},fileFilter:(i,e,t)=>{let r=[".pdf",".jpg",".jpeg",".png"],a=d1.default.extname(e.originalname).toLowerCase();r.includes(a)?t(null,!0):t(new Error("PDF\u3001JPG\u3001PNG\u30D5\u30A1\u30A4\u30EB\u306E\u307F\u30A2\u30C3\u30D7\u30ED\u30FC\u30C9\u3067\u304D\u307E\u3059"))}});function Zt(i,e,t){if(!i.session.userId)return e.status(401).json({message:"\u30ED\u30B0\u30A4\u30F3\u304C\u5FC5\u8981\u3067\u3059"});t()}function Nt(i,e,t){if(!i.session.userId||i.session.role!=="admin")return e.status(403).json({message:"\u7BA1\u7406\u8005\u6A29\u9650\u304C\u5FC5\u8981\u3067\u3059"});t()}function tH(i,e){let t=i.status==="paid"?"\u5165\u91D1\u6E08\u307F":i.status==="overdue"?"\u652F\u6255\u3044\u671F\u9650\u8D85\u904E":"\u672A\u5165\u91D1",a=`${process.env.APP_BASE_URL||`https://${process.env.REPLIT_DEV_DOMAIN||"tramatch.jp"}`}/payment`,c=e?.bankName||"",p=e?.bankBranch||"",f=e?.accountType||"\u666E\u901A",y=e?.accountNumber||"",b=e?.accountHolderKana||"",h=e?.address||"\u795E\u5948\u5DDD\u770C\u611B\u7532\u90E1\u611B\u5DDD\u753A\u4E2D\u6D257287",g=e?.postalCode||"2430303",x=g.length===7?`${g.slice(0,3)}-${g.slice(3)}`:g,E=e?.phone||"046-212-2325",C=(i.description||"\u6708\u984D\u5229\u7528\u6599").split(`
</body></html>`}async function iH(i,e){e.use("/uploads",rH.default.static(h1)),e.post("/api/upload/permit",CEe.single("permit"),(h,g)=>{if(!h.file)return g.status(400).json({message:"\u30D5\u30A1\u30A4\u30EB\u3092\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044"});g.json({filePath:`/uploads/${h.file.filename}`,fileName:h.file.originalname})}),e.post("/api/register",async(h,g)=>{try{let x={...h.body,username:h.body.email,userType:h.body.userType||"carrier"},E=cS.safeParse(x);if(!E.success)return g.status(400).json({message:Cs(E.error).toString()});if(await te.getUserByEmail(E.data.email))return g.status(400).json({message:"\u3053\u306E\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u306F\u65E2\u306B\u767B\u9332\u3055\u308C\u3066\u3044\u307E\u3059"});let A=await es.default.hash(E.data.password,10),I=await te.createUser({...E.data,password:A}),{password:R,...K}=I,W=(await te.getAllUsers()).filter(re=>re.role==="admin");for(let re of W)await te.createNotification({userId:re.id,type:"user_registered",title:"\u65B0\u898F\u30E6\u30FC\u30B6\u30FC\u767B\u9332",message:`${E.data.companyName} \u304C\u65B0\u898F\u767B\u9332\u3057\u307E\u3057\u305F\u3002\u627F\u8A8D\u3092\u304A\u9858\u3044\u3057\u307E\u3059\u3002`,relatedId:I.id});g.status(201).json({...K,message:"\u767B\u9332\u304C\u5B8C\u4E86\u3057\u307E\u3057\u305F\u3002\u7BA1\u7406\u8005\u306E\u627F\u8A8D\u5F8C\u306B\u30ED\u30B0\u30A4\u30F3\u3067\u304D\u307E\u3059\u3002"})}catch{g.status(500).json({message:"\u767B\u9332\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.post("/api/login",async(h,g)=>{try{let{email:x,password:E}=h.body;if(!x||!E)return g.status(400).json({message:"\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u3068\u30D1\u30B9\u30EF\u30FC\u30C9\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044"});let C=await te.getUserByEmail(x);if(!C)return g.status(401).json({message:"\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u307E\u305F\u306F\u30D1\u30B9\u30EF\u30FC\u30C9\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093"});if(!await es.default.compare(E,C.password))return g.status(401).json({message:"\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u307E\u305F\u306F\u30D1\u30B9\u30EF\u30FC\u30C9\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093"});if(!C.approved)return g.status(403).json({message:"\u30A2\u30AB\u30A6\u30F3\u30C8\u306F\u307E\u3060\u627F\u8A8D\u3055\u308C\u3066\u3044\u307E\u305B\u3093\u3002\u7BA1\u7406\u8005\u306E\u627F\u8A8D\u3092\u304A\u5F85\u3061\u304F\u3060\u3055\u3044\u3002"});await te.deleteSessionsByUserId(C.id),h.session.userId=C.id,h.session.role=C.role;let{password:I,...R}=C;g.json(R)}catch{g.status(500).json({message:"\u30ED\u30B0\u30A4\u30F3\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.post("/api/logout",(h,g)=>{h.session.destroy(x=>{if(x)return g.status(500).json({message:"\u30ED\u30B0\u30A2\u30A6\u30C8\u306B\u5931\u6557\u3057\u307E\u3057\u305F"});g.json({message:"\u30ED\u30B0\u30A2\u30A6\u30C8\u3057\u307E\u3057\u305F"})})}),e.post("/api/forgot-password",async(h,g)=>{try{let{email:x}=h.body;if(!x)return g.status(400).json({message:"\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044"});let E=await te.getUserByEmail(x);if(!E)return g.json({message:"\u30D1\u30B9\u30EF\u30FC\u30C9\u30EA\u30BB\u30C3\u30C8\u30E1\u30FC\u30EB\u3092\u9001\u4FE1\u3057\u307E\u3057\u305F"});let C=f1.default.randomBytes(32).toString("hex"),A=f1.default.createHash("sha256").update(C).digest("hex"),I=new Date(Date.now()+3600*1e3);await te.createPasswordResetToken(E.id,A,I);let K=`${process.env.APP_BASE_URL||`https://${process.env.REPLIT_DEV_DOMAIN||"tramatch.jp"}`}/reset-password?token=${C}`,W=await Ic(E.email,"\u3010\u30C8\u30E9\u30DE\u30C3\u30C1\u3011\u30D1\u30B9\u30EF\u30FC\u30C9\u30EA\u30BB\u30C3\u30C8\u306E\u3054\u6848\u5185",`${E.companyName} \u69D8
          </div>`);let Ue=await Ic(A,ye,Ne);Ue.success||console.error("Dispatch request email failed:",Ue.error)}g.json(E)}catch{g.status(500).json({message:"Failed to send dispatch request"})}}),e.get("/api/my-trucks",Zt,async(h,g)=>{try{let E=(await te.getTruckListings()).filter(C=>C.userId===h.session.userId);g.json(E)}catch{g.status(500).json({message:"Failed to fetch user truck listings"})}}),e.get("/api/trucks",async(h,g)=>{try{let x=await te.getTruckListings();g.json(x)}catch{g.status(500).json({message:"Failed to fetch truck listings"})}}),e.get("/api/trucks/:id",Zt,async(h,g)=>{try{let x=await te.getTruckListing(h.params.id);if(!x)return g.status(404).json({message:"Truck listing not found"});g.json(x)}catch{g.status(500).json({message:"Failed to fetch truck listing"})}}),e.post("/api/trucks",Zt,async(h,g)=>{try{let x=await te.getUser(h.session.userId),E={...h.body,companyName:h.body.companyName||x?.companyName||"",contactPhone:h.body.contactPhone||x?.phone||"",contactEmail:h.body.contactEmail||x?.email||""},C=uS.safeParse(E);if(!C.success)return g.status(400).json({message:Cs(C.error).toString()});let A=await te.createTruckListing({...C.data},h.session.userId),I=await te.getAllUsers();for(let R of I)R.id!==h.session.userId&&R.approved&&await te.createNotification({userId:R.id,type:"truck_new",title:"\u65B0\u3057\u3044\u7A7A\u8ECA\u304C\u767B\u9332\u3055\u308C\u307E\u3057\u305F",message:`${A.currentArea}\u2192${A.destinationArea} ${A.vehicleType} ${A.maxWeight}`,relatedId:A.id});g.status(201).json(A)}catch{g.status(500).json({message:"Failed to create truck listing"})}}),e.patch("/api/trucks/:id",Zt,async(h,g)=>{try{let x=h.params.id,E=await te.getTruckListing(x);if(!E)return g.status(404).json({message:"Truck listing not found"});if(E.userId!==h.session.userId)return g.status(403).json({message:"Not authorized"});let C=["title","currentArea","destinationArea","vehicleType","bodyType","maxWeight","availableDate","price","description","status"],A={};for(let R of C)R in h.body&&(A[R]=h.body[R]);let I=await te.updateTruckListing(x,A);g.json(I)}catch{g.status(500).json({message:"Failed to update truck listing"})}}),e.delete("/api/trucks/:id",Zt,async(h,g)=>{try{if(!await te.deleteTruckListing(h.params.id))return g.status(404).json({message:"Truck listing not found"});g.json({message:"Deleted successfully"})}catch{g.status(500).json({message:"Failed to delete truck listing"})}}),e.get("/api/admin/stats",Nt,async(h,g)=>{try{let x=await te.getCargoListings(),E=await te.getTruckListings(),C=await te.getAllUsers();g.json({cargoCount:x.length,truckCount:E.length,userCount:C.length})}catch{g.status(500).json({message:"Failed to fetch stats"})}}),e.get("/api/admin/users",Nt,async(h,g)=>{try{let E=(await te.getAllUsers()).map(({password:C,...A})=>A);g.json(E)}catch{g.status(500).json({message:"Failed to fetch users"})}}),e.patch("/api/admin/users/:id/approve",Nt,async(h,g)=>{try{let x=await te.approveUser(h.params.id);if(!x)return g.status(404).json({message:"\u30E6\u30FC\u30B6\u30FC\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093"});await te.createNotification({userId:x.id,type:"user_approved",title:"\u30A2\u30AB\u30A6\u30F3\u30C8\u627F\u8A8D",message:"\u30A2\u30AB\u30A6\u30F3\u30C8\u304C\u627F\u8A8D\u3055\u308C\u307E\u3057\u305F\u3002\u30ED\u30B0\u30A4\u30F3\u3057\u3066\u30B5\u30FC\u30D3\u30B9\u3092\u3054\u5229\u7528\u304F\u3060\u3055\u3044\u3002"});let E=await te.getUser(h.session.userId);await te.createAuditLog({userId:h.session.userId,userName:E?.companyName||"\u7BA1\u7406\u8005",action:"approve",targetType:"user",targetId:x.id,details:`\u30E6\u30FC\u30B6\u30FC\u300C${x.companyName}\u300D\u3092\u627F\u8A8D`,ipAddress:h.ip});let{password:C,...A}=x;g.json(A)}catch{g.status(500).json({message:"\u627F\u8A8D\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.patch("/api/admin/users/:id/plan",Nt,async(h,g)=>{try{let{plan:x}=h.body;if(!x||!["free","premium","premium_full"].includes(x))return g.status(400).json({message:"\u7121\u52B9\u306A\u30D7\u30E9\u30F3\u3067\u3059"});let E=await te.updateUserProfile(h.params.id,{plan:x});if(!E)return g.status(404).json({message:"\u30E6\u30FC\u30B6\u30FC\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093"});let{password:C,...A}=E;g.json(A)}catch{g.status(500).json({message:"\u30D7\u30E9\u30F3\u5909\u66F4\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.delete("/api/admin/users/:id",Nt,async(h,g)=>{try{let x=await te.getUser(h.params.id);if(!await te.deleteUser(h.params.id))return g.status(404).json({message:"User not found"});let C=await te.getUser(h.session.userId);await te.createAuditLog({userId:h.session.userId,userName:C?.companyName||"\u7BA1\u7406\u8005",action:"delete",targetType:"user",targetId:h.params.id,details:`\u30E6\u30FC\u30B6\u30FC\u300C${x?.companyName}\u300D\u3092\u524A\u9664`,ipAddress:h.ip}),g.json({message:"Deleted successfully"})}catch{g.status(500).json({message:"Failed to delete user"})}}),e.patch("/api/admin/cargo/:id",Nt,async(h,g)=>{try{let x=await te.getCargoListing(h.params.id);if(!x)return g.status(404).json({message:"Cargo listing not found"});let E=["title","departureArea","departureAddress","arrivalArea","arrivalAddress","desiredDate","arrivalDate","departureTime","arrivalTime","cargoType","weight","vehicleType","bodyType","temperatureControl","price","highwayFee","transportType","consolidation","driverWork","packageCount","loadingMethod","urgency","description","status"],C={};for(let R of E)R in h.body&&(C[R]=h.body[R]);let A=await te.updateCargoListing(h.params.id,C),I=await te.getUser(h.session.userId);await te.createAuditLog({userId:h.session.userId,userName:I?.companyName||"\u7BA1\u7406\u8005",action:"edit",targetType:"cargo",targetId:h.params.id,details:`\u8377\u7269\u300C${x.title}\u300D\u3092\u7BA1\u7406\u8005\u304C\u7DE8\u96C6`,ipAddress:h.ip}),g.json(A)}catch{g.status(500).json({message:"Failed to update cargo listing"})}}),e.delete("/api/admin/cargo/:id",Nt,async(h,g)=>{try{let x=await te.getCargoListing(h.params.id);if(!x)return g.status(404).json({message:"Cargo listing not found"});await te.deleteCargoListing(h.params.id);let E=await te.getUser(h.session.userId);await te.createAuditLog({userId:h.session.userId,userName:E?.companyName||"\u7BA1\u7406\u8005",action:"delete",targetType:"cargo",targetId:h.params.id,details:`\u8377\u7269\u300C${x.title}\u300D\u3092\u7BA1\u7406\u8005\u304C\u524A\u9664`,ipAddress:h.ip}),g.json({message:"Deleted successfully"})}catch{g.status(500).json({message:"Failed to delete cargo listing"})}}),e.patch("/api/admin/trucks/:id",Nt,async(h,g)=>{try{let x=await te.getTruckListing(h.params.id);if(!x)return g.status(404).json({message:"Truck listing not found"});let E=["title","currentArea","destinationArea","vehicleType","bodyType","maxWeight","availableDate","price","description","status"],C={};for(let R of E)R in h.body&&(C[R]=h.body[R]);let A=await te.updateTruckListing(h.params.id,C),I=await te.getUser(h.session.userId);await te.createAuditLog({userId:h.session.userId,userName:I?.companyName||"\u7BA1\u7406\u8005",action:"edit",targetType:"truck",targetId:h.params.id,details:`\u8ECA\u4E21\u300C${x.title}\u300D\u3092\u7BA1\u7406\u8005\u304C\u7DE8\u96C6`,ipAddress:h.ip}),g.json(A)}catch{g.status(500).json({message:"Failed to update truck listing"})}}),e.delete("/api/admin/trucks/:id",Nt,async(h,g)=>{try{let x=await te.getTruckListing(h.params.id);if(!x)return g.status(404).json({message:"Truck listing not found"});await te.deleteTruckListing(h.params.id);let E=await te.getUser(h.session.userId);await te.createAuditLog({userId:h.session.userId,userName:E?.companyName||"\u7BA1\u7406\u8005",action:"delete",targetType:"truck",targetId:h.params.id,details:`\u8ECA\u4E21\u300C${x.title}\u300D\u3092\u7BA1\u7406\u8005\u304C\u524A\u9664`,ipAddress:h.ip}),g.json({message:"Deleted successfully"})}catch{g.status(500).json({message:"Failed to delete truck listing"})}}),e.get("/api/admin/audit-logs",Nt,async(h,g)=>{try{let x=parseInt(h.query.page)||1,E=parseInt(h.query.limit)||50,C=(x-1)*E,[A,I]=await Promise.all([te.getAuditLogs(E,C),te.getAuditLogCount()]);g.json({logs:A,total:I,page:x,totalPages:Math.ceil(I/E)})}catch{g.status(500).json({message:"Failed to fetch audit logs"})}}),e.post("/api/contact",async(h,g)=>{try{let x=mS.safeParse(h.body);if(!x.success)return g.status(400).json({message:"\u5165\u529B\u5185\u5BB9\u306B\u8AA4\u308A\u304C\u3042\u308A\u307E\u3059",errors:Cs(x.error).toString()});let E=await te.createContactInquiry(x.data);g.status(201).json({message:"\u304A\u554F\u3044\u5408\u308F\u305B\u3092\u9001\u4FE1\u3057\u307E\u3057\u305F",inquiry:E})}catch{g.status(500).json({message:"\u9001\u4FE1\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.get("/api/admin/contact-inquiries",Nt,async(h,g)=>{try{let x=await te.getContactInquiries();g.json(x)}catch{g.status(500).json({message:"\u53D6\u5F97\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.get("/api/admin/contact-inquiries/unread-count",Nt,async(h,g)=>{try{let x=await te.getUnreadContactCount();g.json({count:x})}catch{g.status(500).json({message:"\u53D6\u5F97\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.patch("/api/admin/contact-inquiries/:id",Nt,async(h,g)=>{try{let{status:x,adminNote:E}=h.body;if(!x||!["unread","read","replied","closed"].includes(x))return g.status(400).json({message:"\u7121\u52B9\u306A\u30B9\u30C6\u30FC\u30BF\u30B9\u3067\u3059"});let C=await te.updateContactInquiryStatus(h.params.id,x,E);if(!C)return g.status(404).json({message:"\u304A\u554F\u3044\u5408\u308F\u305B\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093"});g.json(C)}catch{g.status(500).json({message:"\u66F4\u65B0\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.delete("/api/admin/contact-inquiries/:id",Nt,async(h,g)=>{try{if(!await te.deleteContactInquiry(h.params.id))return g.status(404).json({message:"\u304A\u554F\u3044\u5408\u308F\u305B\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093"});g.json({message:"\u524A\u9664\u3057\u307E\u3057\u305F"})}catch{g.status(500).json({message:"\u524A\u9664\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.post("/api/partners/invite",Zt,async(h,g)=>{try{let{email:x}=h.body;if(!x)return g.status(400).json({message:"\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044"});let E=await te.getUser(h.session.userId);if(!E)return g.status(401).json({message:"\u30E6\u30FC\u30B6\u30FC\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093"});let C=process.env.APP_BASE_URL||`https://${process.env.REPLIT_DEV_DOMAIN||"tramatch.jp"}`,A=await Ic(x,"\u3010\u30C8\u30E9\u30DE\u30C3\u30C1\u3011\u53D6\u5F15\u5148\u62DB\u5F85\u306E\u3054\u6848\u5185",`${E.companyName}\u69D8\u3088\u308A\u30C8\u30E9\u30DE\u30C3\u30C1\u3078\u306E\u62DB\u5F85\u304C\u5C4A\u3044\u3066\u3044\u307E\u3059\u3002
\u5099\u8003: ${C||"\u306A\u3057"}`}],max_tokens:4e3})).choices[0]?.message?.content||"",K=R,W="",re=R.match(/---META---\s*(\{[\s\S]*?\})/);if(re){K=R.replace(/---META---[\s\S]*$/,"").trim();try{W=JSON.parse(re[1]).metaDescription||""}catch{}}let xe=K.match(/^#\s+(.+)$/m),me=xe?xe[1]:x,ye=c(me),Ne=await te.createSeoArticle({topic:x,keywords:E||null,title:me,slug:ye,metaDescription:W||null,content:K,status:A?"published":"draft",autoGenerated:!1});A&&Th(),g.json(Ne)}catch(x){console.error("SEO article generation error:",x),g.status(500).json({message:"\u8A18\u4E8B\u306E\u751F\u6210\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.patch("/api/admin/seo-articles/:id",Nt,async(h,g)=>{try{let x=await te.updateSeoArticle(h.params.id,h.body);if(!x)return g.status(404).json({message:"\u8A18\u4E8B\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093"});h.body.status==="published"&&Th(),g.json(x)}catch{g.status(500).json({message:"\u8A18\u4E8B\u306E\u66F4\u65B0\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.delete("/api/admin/seo-articles/:id",Nt,async(h,g)=>{try{if(!await te.deleteSeoArticle(h.params.id))return g.status(404).json({message:"\u8A18\u4E8B\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093"});g.json({message:"\u8A18\u4E8B\u3092\u524A\u9664\u3057\u307E\u3057\u305F"})}catch{g.status(500).json({message:"\u8A18\u4E8B\u306E\u524A\u9664\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.get("/api/admin/settings",Nt,async(h,g)=>{try{let x=await te.getAllAdminSettings(),E={};for(let C of x)E[C.key]=C.value;g.json(E)}catch{g.status(500).json({message:"\u8A2D\u5B9A\u306E\u53D6\u5F97\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.post("/api/admin/settings",Nt,async(h,g)=>{try{let x=Object.entries(h.body);for(let[E,C]of x)await te.setAdminSetting(E,C);g.json({message:"\u8A2D\u5B9A\u3092\u4FDD\u5B58\u3057\u307E\u3057\u305F"})}catch{g.status(500).json({message:"\u8A2D\u5B9A\u306E\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}});let p={\u5317\u6D77\u9053:"hokkaido",\u9752\u68EE:"aomori",\u5CA9\u624B:"iwate",\u5BAE\u57CE:"miyagi",\u79CB\u7530:"akita",\u5C71\u5F62:"yamagata",\u798F\u5CF6:"fukushima",\u8328\u57CE:"ibaraki",\u6803\u6728:"tochigi",\u7FA4\u99AC:"gunma",\u57FC\u7389:"saitama",\u5343\u8449:"chiba",\u6771\u4EAC:"tokyo",\u795E\u5948\u5DDD:"kanagawa",\u65B0\u6F5F:"niigata",\u5BCC\u5C71:"toyama",\u77F3\u5DDD:"ishikawa",\u798F\u4E95:"fukui",\u5C71\u68A8:"yamanashi",\u9577\u91CE:"nagano",\u5C90\u961C:"gifu",\u9759\u5CA1:"shizuoka",\u611B\u77E5:"aichi",\u4E09\u91CD:"mie",\u6ECB\u8CC0:"shiga",\u4EAC\u90FD:"kyoto",\u5927\u962A:"osaka",\u5175\u5EAB:"hyogo",\u5948\u826F:"nara",\u548C\u6B4C\u5C71:"wakayama",\u9CE5\u53D6:"tottori",\u5CF6\u6839:"shimane",\u5CA1\u5C71:"okayama",\u5E83\u5CF6:"hiroshima",\u5C71\u53E3:"yamaguchi",\u5FB3\u5CF6:"tokushima",\u9999\u5DDD:"kagawa",\u611B\u5A9B:"ehime",\u9AD8\u77E5:"kochi",\u798F\u5CA1:"fukuoka",\u4F50\u8CC0:"saga",\u9577\u5D0E:"nagasaki",\u718A\u672C:"kumamoto",\u5927\u5206:"oita",\u5BAE\u5D0E:"miyazaki",\u9E7F\u5150\u5CF6:"kagoshima",\u6C96\u7E04:"okinawa"};function f(h){let g=h.replace(/[都府県]$/,"");return p[g]||g}e.get("/api/admin/agents/stats",Nt,async(h,g)=>{try{let x=await te.getAgentStats();g.json(x)}catch(x){console.error("Agent stats error:",x),g.status(500).json({message:"\u30A8\u30FC\u30B8\u30A7\u30F3\u30C8\u7D71\u8A08\u306E\u53D6\u5F97\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.get("/api/admin/agents",Nt,async(h,g)=>{try{let x=await te.getAgents();g.json(x)}catch{g.status(500).json({message:"\u4EE3\u7406\u5E97\u4E00\u89A7\u306E\u53D6\u5F97\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.get("/api/admin/agents/:id",Nt,async(h,g)=>{try{let x=await te.getAgent(h.params.id);if(!x)return g.status(404).json({message:"\u4EE3\u7406\u5E97\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093"});g.json(x)}catch{g.status(500).json({message:"\u4EE3\u7406\u5E97\u306E\u53D6\u5F97\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.post("/api/admin/agents",Nt,async(h,g)=>{try{let x=Kx.safeParse(h.body);if(!x.success)return g.status(400).json({message:"\u5165\u529B\u5185\u5BB9\u306B\u8AA4\u308A\u304C\u3042\u308A\u307E\u3059",errors:x.error.errors});let E=f(x.data.prefecture),C=x.data.email||`agent-${E}@tramatch.jp`,A=`agent${Date.now().toString(36)}`,I=await es.default.hash(A,10),R=`agent_${E}_${Date.now()}`,K=await te.getUserByEmail(C),W,re;if(!K){let me=await te.createUser({username:R,password:I,companyName:x.data.companyName,contactName:x.data.contactName||"",phone:x.data.phone||"",email:C,userType:"carrier",role:"user",address:x.data.address||""});await te.approveUser(me.id),W=me.id,re=A}let xe=await te.createAgent({...x.data,userId:W||null,loginEmail:W?C:null});await te.createAuditLog({userId:h.user?.id,userName:h.user?.contactName||h.user?.companyName,action:"create",targetType:"agent",targetId:xe.id,details:`\u4EE3\u7406\u5E97\u300C${xe.companyName}\u300D(${xe.prefecture})\u3092\u767B\u9332${W?` / \u30A2\u30AB\u30A6\u30F3\u30C8\u4F5C\u6210 (${C})`:""}`,ipAddress:h.ip}),g.status(201).json({...xe,generatedPassword:re})}catch(x){console.error("Agent creation error:",x),g.status(500).json({message:"\u4EE3\u7406\u5E97\u306E\u767B\u9332\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.patch("/api/admin/agents/:id",Nt,async(h,g)=>{try{let E=Kx.partial().safeParse(h.body);if(!E.success)return g.status(400).json({message:"\u5165\u529B\u5185\u5BB9\u306B\u8AA4\u308A\u304C\u3042\u308A\u307E\u3059",errors:E.error.errors});let C=await te.updateAgent(h.params.id,E.data);if(!C)return g.status(404).json({message:"\u4EE3\u7406\u5E97\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093"});if(C.userId){let A={};E.data.companyName!==void 0&&(A.companyName=E.data.companyName),E.data.contactName!==void 0&&(A.contactName=E.data.contactName),E.data.phone!==void 0&&(A.phone=E.data.phone),E.data.address!==void 0&&(A.address=E.data.address),E.data.fax!==void 0&&(A.fax=E.data.fax),Object.keys(A).length>0&&await te.updateUserProfile(C.userId,A)}await te.createAuditLog({userId:h.user?.id,userName:h.user?.contactName||h.user?.companyName,action:"update",targetType:"agent",targetId:C.id,details:`\u4EE3\u7406\u5E97\u300C${C.companyName}\u300D(${C.prefecture})\u3092\u66F4\u65B0`,ipAddress:h.ip}),g.json(C)}catch{g.status(500).json({message:"\u4EE3\u7406\u5E97\u306E\u66F4\u65B0\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.delete("/api/admin/agents/:id",Nt,async(h,g)=>{try{let x=await te.getAgent(h.params.id);if(!x)return g.status(404).json({message:"\u4EE3\u7406\u5E97\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093"});await te.deleteAgent(h.params.id),await te.createAuditLog({userId:h.user?.id,userName:h.user?.contactName||h.user?.companyName,action:"delete",targetType:"agent",targetId:h.params.id,details:`\u4EE3\u7406\u5E97\u300C${x.companyName}\u300D(${x.prefecture})\u3092\u524A\u9664`,ipAddress:h.ip}),g.json({message:"\u4EE3\u7406\u5E97\u3092\u524A\u9664\u3057\u307E\u3057\u305F"})}catch{g.status(500).json({message:"\u4EE3\u7406\u5E97\u306E\u524A\u9664\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.post("/api/admin/agents/:id/create-account",Nt,async(h,g)=>{try{let x=await te.getAgent(h.params.id);if(!x)return g.status(404).json({message:"\u4EE3\u7406\u5E97\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093"});if(x.userId)return g.status(400).json({message:"\u3053\u306E\u4EE3\u7406\u5E97\u306B\u306F\u3059\u3067\u306B\u30A2\u30AB\u30A6\u30F3\u30C8\u304C\u3042\u308A\u307E\u3059"});let E=f(x.prefecture),C=x.email||`agent-${E}@tramatch.jp`,A=`agent${Date.now().toString(36)}`,I=await es.default.hash(A,10),R=`agent_${E}_${Date.now()}`;if(await te.getUserByEmail(C))return g.status(400).json({message:`\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u300C${C}\u300D\u306F\u65E2\u306B\u4F7F\u7528\u3055\u308C\u3066\u3044\u307E\u3059\u3002\u5225\u306E\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u3092\u8A2D\u5B9A\u3057\u3066\u304F\u3060\u3055\u3044\u3002`});let W=await te.createUser({username:R,password:I,companyName:x.companyName,contactName:x.contactName||"",phone:x.phone||"",email:C,userType:"carrier",role:"user",address:x.address||""});await te.approveUser(W.id),await te.updateAgent(x.id,{userId:W.id,loginEmail:C}),await te.createAuditLog({userId:h.user?.id,userName:h.user?.contactName||h.user?.companyName,action:"create",targetType:"agent_account",targetId:x.id,details:`\u4EE3\u7406\u5E97\u300C${x.companyName}\u300D\u306E\u30ED\u30B0\u30A4\u30F3\u30A2\u30AB\u30A6\u30F3\u30C8\u3092\u4F5C\u6210 (${C})`,ipAddress:h.ip}),g.json({loginEmail:C,generatedPassword:A})}catch(x){console.error("Agent account creation error:",x),g.status(500).json({message:"\u30A2\u30AB\u30A6\u30F3\u30C8\u4F5C\u6210\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.post("/api/admin/agents/:id/reset-password",Nt,async(h,g)=>{try{let x=await te.getAgent(h.params.id);if(!x)return g.status(404).json({message:"\u4EE3\u7406\u5E97\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093"});if(!x.userId)return g.status(400).json({message:"\u3053\u306E\u4EE3\u7406\u5E97\u306B\u306F\u30A2\u30AB\u30A6\u30F3\u30C8\u304C\u3042\u308A\u307E\u305B\u3093"});let E=`agent${Date.now().toString(36)}`,C=await es.default.hash(E,10);await te.updateUserPassword(x.userId,C),await te.createAuditLog({userId:h.user?.id,userName:h.user?.contactName||h.user?.companyName,action:"update",targetType:"agent_account",targetId:x.id,details:`\u4EE3\u7406\u5E97\u300C${x.companyName}\u300D\u306E\u30D1\u30B9\u30EF\u30FC\u30C9\u3092\u30EA\u30BB\u30C3\u30C8`,ipAddress:h.ip}),g.json({newPassword:E,loginEmail:x.loginEmail})}catch{g.status(500).json({message:"\u30D1\u30B9\u30EF\u30FC\u30C9\u30EA\u30BB\u30C3\u30C8\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.post("/api/admin/agents/bulk-create-accounts",Nt,async(h,g)=>{try{let E=(await te.getAgents()).filter(I=>!I.userId),C=[],A=[];for(let I of E){let R=f(I.prefecture),K=I.email||`agent-${R}@tramatch.jp`,W=`agent${Date.now().toString(36)}${Math.random().toString(36).slice(2,4)}`,re=await es.default.hash(W,10),xe=`agent_${R}_${Date.now()}`;if(await te.getUserByEmail(K)){A.push(`${I.prefecture}: \u30E1\u30FC\u30EB\u300C${K}\u300D\u304C\u65E2\u306B\u4F7F\u7528\u4E2D`);continue}let ye=await te.createUser({username:xe,password:re,companyName:I.companyName,contactName:I.contactName||"",phone:I.phone||"",email:K,userType:"carrier",role:"user",address:I.address||""});await te.approveUser(ye.id),await te.updateAgent(I.id,{userId:ye.id,loginEmail:K}),C.push({prefecture:I.prefecture,loginEmail:K,password:W})}await te.createAuditLog({userId:h.user?.id,userName:h.user?.contactName||h.user?.companyName,action:"create",targetType:"agent_account",targetId:"bulk",details:`\u4EE3\u7406\u5E97\u30A2\u30AB\u30A6\u30F3\u30C8\u4E00\u62EC\u4F5C\u6210: ${C.length}\u4EF6\u4F5C\u6210, ${A.length}\u4EF6\u30B9\u30AD\u30C3\u30D7`,ipAddress:h.ip}),g.json({created:C.length,skipped:A.length,results:C,skippedDetails:A})}catch(x){console.error("Bulk account creation error:",x),g.status(500).json({message:"\u4E00\u62EC\u30A2\u30AB\u30A6\u30F3\u30C8\u4F5C\u6210\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}});let y=ut.object({sourceId:ut.string().min(1),planType:ut.enum(["premium","premium_full"])}),b={premium:5500,premium_full:5500};return e.post("/api/payments/square",Zt,async(h,g)=>{try{let x=y.safeParse(h.body);if(!x.success)return g.status(400).json({message:"\u6C7A\u6E08\u60C5\u5831\u304C\u4E0D\u6B63\u3067\u3059",errors:x.error.errors});let{sourceId:E,planType:C}=x.data,A=b[C],I="\u03B2\u7248\u30D7\u30EC\u30DF\u30A2\u30E0\u30D7\u30E9\u30F3\u6708\u984D\u6599\u91D1",R=process.env.SQUARE_ACCESS_TOKEN,K=process.env.SQUARE_LOCATION_ID;if(!R||!K)return g.status(500).json({message:"Square\u6C7A\u6E08\u306E\u8A2D\u5B9A\u304C\u5B8C\u4E86\u3057\u3066\u3044\u307E\u305B\u3093"});let W=new hu.SquareClient({token:R,environment:process.env.SQUARE_ENVIRONMENT==="production"?hu.SquareEnvironment.Production:hu.SquareEnvironment.Sandbox}),re=`${Date.now()}-${Math.random().toString(36).substring(2,10)}`,xe=await te.createPayment({userId:h.session.userId,amount:A,currency:"JPY",squarePaymentId:null,status:"pending",description:I}),me=await W.payments.create({sourceId:E,idempotencyKey:re,amountMoney:{amount:BigInt(A),currency:"JPY"},locationId:K}),ye=me.payment?.id||null,Ue=me.payment?.status==="COMPLETED"?"completed":"failed";await te.updatePaymentStatus(xe.id,Ue,ye),g.json({success:Ue==="completed",paymentId:xe.id,status:Ue})}catch(x){if(console.error("Square payment error:",x),x instanceof hu.SquareError){let E=x.errors?.[0]?.code||"",A={INSUFFICIENT_FUNDS:"\u30AB\u30FC\u30C9\u306E\u6B8B\u9AD8\u304C\u4E0D\u8DB3\u3057\u3066\u3044\u307E\u3059\u3002\u5225\u306E\u30AB\u30FC\u30C9\u3092\u304A\u8A66\u3057\u304F\u3060\u3055\u3044\u3002",CARD_DECLINED:"\u30AB\u30FC\u30C9\u304C\u62D2\u5426\u3055\u308C\u307E\u3057\u305F\u3002\u30AB\u30FC\u30C9\u767A\u884C\u4F1A\u793E\u306B\u304A\u554F\u3044\u5408\u308F\u305B\u304F\u3060\u3055\u3044\u3002",INVALID_CARD:"\u30AB\u30FC\u30C9\u60C5\u5831\u304C\u7121\u52B9\u3067\u3059\u3002\u5165\u529B\u5185\u5BB9\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002",CARD_EXPIRED:"\u30AB\u30FC\u30C9\u306E\u6709\u52B9\u671F\u9650\u304C\u5207\u308C\u3066\u3044\u307E\u3059\u3002",CVV_FAILURE:"\u30BB\u30AD\u30E5\u30EA\u30C6\u30A3\u30B3\u30FC\u30C9\uFF08CVV\uFF09\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093\u3002",INVALID_EXPIRATION:"\u6709\u52B9\u671F\u9650\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093\u3002",ADDRESS_VERIFICATION_FAILURE:"\u4F4F\u6240\u306E\u78BA\u8A8D\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002",GENERIC_DECLINE:"\u30AB\u30FC\u30C9\u304C\u62D2\u5426\u3055\u308C\u307E\u3057\u305F\u3002\u5225\u306E\u30AB\u30FC\u30C9\u3092\u304A\u8A66\u3057\u304F\u3060\u3055\u3044\u3002",TEMPORARILY_UNAVAILABLE:"\u4E00\u6642\u7684\u306B\u30B5\u30FC\u30D3\u30B9\u304C\u5229\u7528\u3067\u304D\u307E\u305B\u3093\u3002\u3057\u3070\u3089\u304F\u3057\u3066\u304B\u3089\u518D\u5EA6\u304A\u8A66\u3057\u304F\u3060\u3055\u3044\u3002"}[E]||"\u30AB\u30FC\u30C9\u6C7A\u6E08\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002\u5225\u306E\u30AB\u30FC\u30C9\u3092\u304A\u8A66\u3057\u304F\u3060\u3055\u3044\u3002";return g.status(400).json({message:A})}g.status(500).json({message:"\u6C7A\u6E08\u51E6\u7406\u4E2D\u306B\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F\u3002\u3057\u3070\u3089\u304F\u3057\u3066\u304B\u3089\u518D\u5EA6\u304A\u8A66\u3057\u304F\u3060\u3055\u3044\u3002"})}}),e.get("/api/payments",Zt,async(h,g)=>{try{let x=await te.getPaymentsByUser(h.session.userId);g.json(x)}catch{g.status(500).json({message:"\u6C7A\u6E08\u5C65\u6B74\u306E\u53D6\u5F97\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.get("/api/admin/invoices",Nt,async(h,g)=>{try{let x=await te.getInvoices();g.json(x)}catch{g.status(500).json({message:"\u8ACB\u6C42\u66F8\u4E00\u89A7\u306E\u53D6\u5F97\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.get("/api/admin/invoices/:id",Nt,async(h,g)=>{try{let x=await te.getInvoice(h.params.id);if(!x)return g.status(404).json({message:"\u8ACB\u6C42\u66F8\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093"});g.json(x)}catch{g.status(500).json({message:"\u8ACB\u6C42\u66F8\u306E\u53D6\u5F97\u306B\u5931\u6557\u3057\u307E\u3057\u305F"})}}),e.post("/api/admin/invoices/generate",Nt,async(h,g)=>{try{let{userIds:x,billingMonth:E}=h.body;if(!E)return g.status(400).json({message:"\u8ACB\u6C42\u6708\u3092\u6307\u5B9A\u3057\u3066\u304F\u3060\u3055\u3044"});let C=await te.getAllUsers(),A=x&&x.length>0?C.filter(R=>x.includes(R.id)):C.filter(R=>R.role!=="admin"&&R.approved&&(R.plan==="premium"||R.plan==="premium_full")),I=[];for(let R of A){let K=R.plan==="premium_full"?5500:0;if(K===0)continue;let re=C.filter(Re=>Re.addedByUserId===R.id&&Re.approved).length,xe=re*2750,me=K+xe,ye=me-Math.floor(me/1.1),Ne=me-ye,Ue=await te.getNextInvoiceNumber(),[ot,wt]=E.split("-"),Ht=parseInt(wt)+1,Tt=Ht>12?parseInt(ot)+1:parseInt(ot),Ct=Ht>12?1:Ht,qt=`${Tt}-${String(Ct).toString().padStart(2,"0")}-\u672B\u65E5`,vt=`\u30C8\u30E9\u30DE\u30C3\u30C1 \u30D7\u30EC\u30DF\u30A2\u30E0\u30D7\u30E9\u30F3\u6708\u984D\u5229\u7528\u6599\uFF08${E}\uFF09\xA55,500\uFF08\u7A0E\u8FBC\uFF09`;re>0&&(vt+=`
root@srv1087935:/var/www/tramatch# 
